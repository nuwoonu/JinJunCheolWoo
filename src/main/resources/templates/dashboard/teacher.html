<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>교사 Dashboard</title>
  </head>
  <body>
    <div layout:fragment="content">

      <!-- ===== Header ===== -->
      <div class="breadcrumb d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <div>
          <h6 class="fw-semibold mb-0">선생님 대시보드</h6>
          <p class="text-neutral-600 mt-4 mb-0">
            <span th:if="${teacherSubject != null and teacherSubject != ''}"
                  th:text="${teacherSubject}">수학</span>
            <span th:if="${teacherSubject != null and teacherSubject != ''}"> | </span>
            <span th:text="${teacherName != null ? teacherName : '선생님'}">박선생</span>선생
          </p>
        </div>
      </div>

      <div class="mt-24">
        <div class="row gy-4">

          <!-- ===== 1. 알림 메시지 ===== -->
          <div class="col-xxl-4 col-lg-6">
            <div class="card h-100">
              <div class="card-body p-0">
                <div class="d-flex align-items-center gap-10 px-20 py-16 border-bottom border-neutral-200">
                  <iconify-icon icon="mdi:bell-outline" class="icon text-lg text-primary-600"></iconify-icon>
                  <h6 class="text-lg mb-0 fw-semibold">알림 메시지</h6>
                </div>
                <div class="px-16 py-12">

                  <!-- 공지사항 있을 때 -->
                  <div th:if="${notices != null and !notices.isEmpty()}" class="d-flex flex-column gap-4">
                    <div th:each="notice, iterStat : ${notices}"
                         th:classappend="${iterStat.index < 2 ? 'bg-warning-focus' : ''}"
                         class="d-flex flex-column gap-6 p-12 radius-8">
                      <div class="d-flex align-items-start justify-content-between gap-8">
                        <h6 class="text-sm fw-semibold mb-0 flex-grow-1"
                            style="word-break: keep-all;"
                            th:text="${notice.title}">알림 제목</h6>
                        <div class="d-flex align-items-center gap-6 flex-shrink-0">
                          <span th:if="${iterStat.index < 2}"
                                class="badge bg-danger text-white text-xs px-8 py-2 radius-4 fw-semibold">NEW</span>
                          <span class="text-secondary-light text-xs"
                                th:if="${notice.createDate != null}"
                                th:text="${#temporals.format(notice.createDate, 'M/d')}">1/29</span>
                        </div>
                      </div>
                      <p class="text-secondary-light text-xs mb-0"
                         th:text="${notice.writerName != null ? notice.writerName + ' | ' : ''}
                                  + ${#strings.abbreviate(notice.content ?: '', 50)}">내용</p>
                    </div>
                  </div>

                  <!-- 공지사항 없을 때 -->
                  <div th:if="${notices == null or notices.isEmpty()}"
                       class="text-center py-32 text-secondary-light">
                    <iconify-icon icon="mdi:bell-off-outline" class="text-4xl d-block mb-8"></iconify-icon>
                    <p class="text-sm mb-0">새로운 알림이 없습니다.</p>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- ===== 2. 오늘의 시간표 (React Island - 기존 유지) ===== -->
          <div class="col-xxl-4 col-lg-6">
            <div id="dashboard-schedule-root"></div>
            <script type="module" th:src="@{/js/react/teacher/dashboard.js}"></script>
          </div>

          <!-- ===== 3. 학교 일정 ===== -->
          <div class="col-xxl-4 col-lg-6">
            <div class="card h-100">
              <div class="card-body p-0">
                <div class="d-flex align-items-center gap-10 px-20 py-16 border-bottom border-neutral-200">
                  <iconify-icon icon="mdi:calendar-month-outline" class="icon text-lg text-success-600"></iconify-icon>
                  <h6 class="text-lg mb-0 fw-semibold">학교 일정</h6>
                </div>
                <div class="px-16 py-12">
                  <div class="d-flex flex-column gap-10" id="school-events-list">
                    <!-- JS로 동적 생성 -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== 4. 과제 제출 확인 ===== -->
          <div class="col-xxl-8">
            <div class="card">
              <div class="card-body p-0">
                <div class="d-flex align-items-center gap-10 px-20 py-16 border-bottom border-neutral-200">
                  <iconify-icon icon="mdi:clipboard-text-outline" class="icon text-lg text-warning-600"></iconify-icon>
                  <h6 class="text-lg mb-0 fw-semibold">과제 제출 확인</h6>
                </div>
                <div class="p-20">
                  <div class="d-flex flex-column gap-24">

                    <!-- 과제 1 -->
                    <div>
                      <div class="d-flex align-items-center justify-content-between mb-8">
                        <div>
                          <h6 class="text-md fw-semibold mb-2">기하학 프로젝트</h6>
                          <span class="text-secondary-light text-sm">3학년 4반 &nbsp;마감: 01/29</span>
                        </div>
                        <span class="badge bg-warning-100 text-warning-600 fw-semibold radius-4 px-12 py-6">15/29</span>
                      </div>
                      <div class="progress" style="height:8px; border-radius:4px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width:52%;" aria-valuenow="52" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>

                    <!-- 과제 2 -->
                    <div>
                      <div class="d-flex align-items-center justify-content-between mb-8">
                        <div>
                          <h6 class="text-md fw-semibold mb-2">확률과 통계 과제</h6>
                          <span class="text-secondary-light text-sm">2학년 1반 &nbsp;마감: 01/30</span>
                        </div>
                        <span class="badge bg-success-100 text-success-600 fw-semibold radius-4 px-12 py-6">25/31</span>
                      </div>
                      <div class="progress" style="height:8px; border-radius:4px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width:81%;" aria-valuenow="81" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>

                    <!-- 과제 3 -->
                    <div>
                      <div class="d-flex align-items-center justify-content-between mb-8">
                        <div>
                          <h6 class="text-md fw-semibold mb-2">미적분 연습문제</h6>
                          <span class="text-secondary-light text-sm">3학년 2반 &nbsp;마감: 02/01</span>
                        </div>
                        <span class="badge bg-danger-100 text-danger-600 fw-semibold radius-4 px-12 py-6">10/28</span>
                      </div>
                      <div class="progress" style="height:8px; border-radius:4px;">
                        <div class="progress-bar bg-danger" role="progressbar"
                             style="width:36%;" aria-valuenow="36" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== 5. 학급 학생 출결 상태 ===== -->
          <div class="col-xxl-4">
            <div class="card h-100">
              <div class="card-body p-0">
                <div class="d-flex align-items-center gap-10 px-20 py-16 border-bottom border-neutral-200">
                  <iconify-icon icon="mdi:account-group-outline" class="icon text-lg text-info-600"></iconify-icon>
                  <h6 class="text-lg mb-0 fw-semibold">학급 학생 출결 상태</h6>
                </div>

                <!-- 학급 정보 있을 때 -->
                <div th:if="${classInfo != null}" class="p-16">
                  <!-- 반 정보 & 출결 요약 -->
                  <div class="mb-12">
                    <p class="text-sm text-secondary-light mb-8"
                       th:text="${classInfo.grade + '학년 ' + classInfo.classNum + '반 (' + classInfo.totalStudents + '명)'}">
                      1학년 2반 (10명)
                    </p>
                    <div class="d-flex gap-6 flex-wrap">
                      <span class="badge bg-success-100 text-success-600 px-10 py-4 radius-4 fw-medium text-xs">
                        출석: <span th:text="${classInfo.totalStudents}">10</span>
                      </span>
                      <span class="badge bg-warning-100 text-warning-600 px-10 py-4 radius-4 fw-medium text-xs">지각: 0</span>
                      <span class="badge bg-danger-100 text-danger-600 px-10 py-4 radius-4 fw-medium text-xs">결석: 0</span>
                      <span class="badge bg-secondary-100 text-secondary-600 px-10 py-4 radius-4 fw-medium text-xs">조퇴: 0</span>
                    </div>
                  </div>

                  <!-- 학생 목록 -->
                  <div class="d-flex flex-column gap-0 max-h-320-px overflow-y-auto scroll-sm">
                    <div th:each="student : ${classInfo.students}"
                         class="d-flex align-items-center justify-content-between py-10 border-bottom border-neutral-100">
                      <div>
                        <h6 class="text-sm fw-medium mb-1" th:text="${student.name}">학생명</h6>
                        <span class="text-xs text-secondary-light"
                              th:text="${student.studentNumber != null ? student.studentNumber + '번' : '-'}">1번</span>
                      </div>
                      <span class="badge bg-success-100 text-success-600 px-10 py-4 radius-4 fw-medium text-xs">출석</span>
                    </div>
                    <!-- 학생 없을 때 -->
                    <div th:if="${classInfo.students == null or classInfo.students.isEmpty()}"
                         class="text-center py-16 text-secondary-light">
                      <p class="text-sm mb-0">배정된 학생이 없습니다.</p>
                    </div>
                  </div>
                </div>

                <!-- 학급 정보 없을 때 -->
                <div th:if="${classInfo == null}" class="p-20 text-center text-secondary-light">
                  <iconify-icon icon="mdi:account-off-outline" class="text-4xl d-block mb-8"></iconify-icon>
                  <p class="text-sm mb-0">담당 학급 정보가 없습니다.</p>
                  <p class="text-xs mb-0 mt-4">관리자에게 학급 배정을 요청하세요.</p>
                </div>

              </div>
            </div>
          </div>

        </div><!-- /row -->
      </div>
    </div><!-- /content -->

    <th:block layout:fragment="script">
      <script>
        // ===== 학교 일정 D-day 계산 =====
        (function () {
          const events = [
            { date: '2026-01-23', label: '1/23(금) 겨울방학식' },
            { date: '2026-02-10', label: '2/10(수) 개학식' },
            { date: '2026-03-02', label: '3/2(월) 새학기 시작' },
            { date: '2026-05-05', label: '5/5(화) 어린이날' },
          ];

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const container = document.getElementById('school-events-list');
          if (!container) return;

          events.forEach(function (evt) {
            const evtDate = new Date(evt.date);
            evtDate.setHours(0, 0, 0, 0);
            const diffDays = Math.round((evtDate - today) / (1000 * 60 * 60 * 24));

            let dLabel, badgeStyle;
            if (diffDays === 0) {
              dLabel = 'D-Day';
              badgeStyle = 'background:#dc3545; color:#fff;';
            } else if (diffDays > 0) {
              dLabel = 'D-' + diffDays;
              badgeStyle = 'background:#d1f7e8; color:#198754;';
            } else {
              dLabel = 'D+' + Math.abs(diffDays);
              badgeStyle = 'background:#e9ecef; color:#6c757d;';
            }

            const div = document.createElement('div');
            div.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f0faf5; border-radius:8px;';
            div.innerHTML =
              '<div style="display:flex; align-items:center; gap:10px;">' +
                '<iconify-icon icon="mdi:calendar-check-outline" style="font-size:18px; color:#198754;"></iconify-icon>' +
                '<span style="font-size:13px; font-weight:500;">' + evt.label + '</span>' +
              '</div>' +
              '<span style="' + badgeStyle + ' padding:3px 10px; border-radius:4px; font-size:11px; font-weight:700;">' + dLabel + '</span>';

            container.appendChild(div);
          });
        })();
      </script>
    </th:block>
  </body>
</html>
