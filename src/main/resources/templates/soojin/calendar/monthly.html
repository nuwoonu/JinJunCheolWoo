<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>학사 일정 (월별)</title>

    <th:block layout:fragment="css">
      <style>
        .event-EVENT {
          background-color: #0d6efd !important;
          color: #fff !important;
        }
        .event-EXAM {
          background-color: #dc3545 !important;
          color: #fff !important;
        }
        .event-HOLIDAY {
          background-color: #ffc107 !important;
          color: #000 !important;
        }
        .event-VACATION {
          background-color: #198754 !important;
          color: #fff !important;
        }
        .event-FIELD_TRIP {
          background-color: #0dcaf0 !important;
          color: #000 !important;
        }
        .event-MEETING {
          background-color: #6610f2 !important;
          color: #fff !important;
        }
        .event-BRIEFING {
          background-color: #d63384 !important;
          color: #fff !important;
        }
        .event-OTHER {
          background-color: #6c757d !important;
          color: #fff !important;
        }

        #calendar {
          max-width: 1100px;
          margin: 0 auto;
        }
        a {
          text-decoration: none;
          color: inherit;
        }

        .fc-toolbar-title {
          font-size: 1.5rem !important; /* 원하는 크기로 조절 */
        }
      </style>
    </th:block>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white p-20 border-bottom d-flex justify-content-between align-items-center">
          <h5 class="fw-bold mb-0"><i class="ri-calendar-2-line me-8"></i>학사 일정</h5>
          <div>
            <a class="btn btn-outline-primary me-2" th:href="@{/soojin/calendar/list}"> 목록 보기 </a>

            <a sec:authorize="hasRole('ADMIN')" th:href="@{/soojin/admin/add}" class="btn btn-primary"> + 일정 등록 </a>
          </div>
        </div>
        <div class="card-body p-20">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
      <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
          const calendarEl = document.getElementById("calendar");
          const initialYear = [[${year ?: T(java.time.LocalDate).now().year}]];
          const initialMonth = [[${month ?: T(java.time.LocalDate).now().monthValue}]];

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            initialDate: `${initialYear}-${String(initialMonth).padStart(2, "0")}-01`,
            locale: "ko",
            height: "auto",
            contentHeight: "auto",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "",
            },
            events: function (fetchInfo, successCallback, failureCallback) {
              const midDate = new Date(
                fetchInfo.start.getTime() + (fetchInfo.end.getTime() - fetchInfo.start.getTime()) / 2,
              );
              const fetchYear = midDate.getFullYear();
              const fetchMonth = midDate.getMonth() + 1;

              fetch(`/soojin/api/events?year=${fetchYear}&month=${fetchMonth}`)
                .then((response) => response.json())
                .then((data) => {
                  const events = data.map((e) => ({
                    id: e.id,
                    title: e.title,
                    start: e.startDate,
                    end: e.endDate,
                    className: "event-" + e.eventType,
                    extendedProps: {
                      description: e.description,
                    },
                  }));
                  successCallback(events);
                })
                .catch((error) => {
                  console.error("일정 정보를 불러오는 중 오류가 발생했습니다:", error);
                  failureCallback(error);
                });
            },
            eventClick: function (info) {
              /*[# sec:authorize="hasRole('ADMIN')"]*/
              location.href = "/soojin/admin/edit/" + info.event.id;
              /*[/]*/

              /*[# sec:authorize="!hasRole('ADMIN')"]*/
              alert(info.event.title);
              /*[/]*/
            },
          });
          calendar.render();
        });
      </script>
    </th:block>
  </body>
</html>
<!--  -->
