<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>학사 일정 (월별)</title>

    <th:block layout:fragment="css">
      <style>
        .event-EVENT {
          background-color: #0d6efd !important;
          color: #fff !important;
        }
        .event-EXAM {
          background-color: #dc3545 !important;
          color: #fff !important;
        }
        .event-HOLIDAY {
          background-color: #ffc107 !important;
          color: #000 !important;
        }
        .event-VACATION {
          background-color: #198754 !important;
          color: #fff !important;
        }
        .event-FIELD_TRIP {
          background-color: #0dcaf0 !important;
          color: #000 !important;
        }
        .event-MEETING {
          background-color: #6610f2 !important;
          color: #fff !important;
        }
        .event-BRIEFING {
          background-color: #d63384 !important;
          color: #fff !important;
        }
        .event-OTHER {
          background-color: #6c757d !important;
          color: #fff !important;
        }

        #calendar {
          max-width: 1100px;
          margin: 0 auto;
        }
        a {
          text-decoration: none;
          color: inherit;
        }
      </style>
    </th:block>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>학사 일정</h2>

        <div>
          <a class="btn btn-outline-primary me-2" th:href="@{/soojin/calendar/list}"> 목록 보기 </a>

          <a sec:authorize="hasRole('ADMIN')" th:href="@{/soojin/admin/add}" class="btn btn-primary"> + 일정 등록 </a>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

      <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {

            var initialYear = [[${year ?: T(java.time.LocalDate).now().year}]];
            var initialMonth = [[${month ?: T(java.time.LocalDate).now().monthValue}]];
            var initialDate = new Date(initialYear, initialMonth - 1, 1);

            var calendar = new FullCalendar.Calendar(
                document.getElementById('calendar'), {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    initialDate: initialDate,

                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: ''
                    },

                    events: function (info, success, failure) {
                        var date = new Date((info.start.getTime() + info.end.getTime()) / 2);
                        var year = date.getFullYear();
                        var month = date.getMonth() + 1;

                        fetch(`/soojin/api/events?year=${year}&month=${month}`)
                            .then(res => res.json())
                            .then(data => {
                                success(data.map(e => ({
                                    id: e.id,
                                    title: e.title,
                                    start: e.startDate,
                                    end: e.endDate,
                                    className: 'event-' + e.eventType,
                                    extendedProps: {
                                        description: e.description
                                    }
                                })));
                            })
                            .catch(err => failure(err));
                    },

                    eventClick: function (info) {
                        /*[# sec:authorize="hasRole('ADMIN')"]*/
                        location.href = '/soojin/admin/edit/' + info.event.id;
                        /*[/]*/

                        /*[# sec:authorize="!hasRole('ADMIN')"]*/
                        alert(info.event.title);
                        /*[/]*/
                    }
                });

            calendar.render();
        });
      </script>
    </th:block>
  </body>
</html>
<!--  -->
