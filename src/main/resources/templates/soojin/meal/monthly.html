<!doctype html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>월별 급식</title>

    <th:block layout:fragment="css">
      <style>
        /* ===============================
           급식 종류별 배경색
        =============================== */
        .fc-event.meal-BREAKFAST {
          background-color: #ffc107 !important;
          border-color: #ffc107 !important;
        }

        .fc-event.meal-LUNCH {
          background-color: #fff3cd !important;
          border-color: #fff3cd !important;
        }

        .fc-event.meal-DINNER {
          background-color: #198754 !important;
          border-color: #198754 !important;
        }

        /* ===============================
           실제 텍스트 색상 (핵심)
        =============================== */
        .fc-event .fc-event-title {
          color: #000 !important;
        }

        /* ===============================
           이벤트 글자 줄바꿈 + 전체 노출
        =============================== */
        .fc-event-title {
          white-space: normal !important;
          word-break: break-word;
          line-height: 1.2;
          font-size: 0.8em !important;
          padding: 2px !important;
        }

        /* ===============================
           날짜 칸 높이 확장 (핵심)
        =============================== */
        .fc-daygrid-day-frame {
          min-height: 140px !important;
          height: auto !important;
        }

        /* 이벤트 영역 잘림 제거 */
        .fc-daygrid-day-events {
          overflow: visible !important;
        }

        .fc-daygrid-event,
        .fc-daygrid-event-harness {
          max-height: none !important;
          overflow: visible !important;
        }

        /* +n more 숨김 */
        .fc-daygrid-more-link {
          display: none;
        }

        /* 캘린더 상단 제목 */
        .fc-toolbar-title {
          font-size: 1.5rem !important;
        }
      </style>
    </th:block>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white p-20 border-bottom d-flex justify-content-between align-items-center">
          <h5 class="fw-bold mb-0"><i class="fa-solid fa-utensils me-8"></i> 월별 급식표</h5>
          <div>
            <select id="mealTypeFilter" class="form-select form-select-sm" style="width: 120px">
              <option value="">전체</option>
              <option value="BREAKFAST">조식</option>
              <option value="LUNCH">중식</option>
              <option value="DINNER">석식</option>
            </select>
          </div>
        </div>

        <div class="card-body p-20">
          <div id="mealCalendar"></div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
      <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
          const calendarEl = document.getElementById("mealCalendar");
          const now = new Date();
          const mealTypeFilter = document.getElementById("mealTypeFilter");

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            initialDate: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-01`,
            locale: "ko",

            height: "auto",
            expandRows: true,

            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,listWeek",
            },

            events: function (fetchInfo, successCallback, failureCallback) {
              const midDate = new Date(
                fetchInfo.start.getTime() + (fetchInfo.end.getTime() - fetchInfo.start.getTime()) / 2,
              );

              let apiUrl = `/soojin/api/meals?year=${midDate.getFullYear()}&month=${midDate.getMonth() + 1}`;

              if (mealTypeFilter.value) {
                apiUrl += `&mealType=${mealTypeFilter.value}`;
              }

              fetch(apiUrl)
                .then((res) => res.json())
                .then((data) => {
                  successCallback(
                    data.map((meal) => ({
                      title: `[${
                        meal.mealType === "BREAKFAST" ? "조식" : meal.mealType === "LUNCH" ? "중식" : "석식"
                      }] ${meal.menu}`,
                      start: meal.mealDate,
                      allDay: true,
                      className: "meal-" + meal.mealType,
                      extendedProps: meal,
                    })),
                  );
                })
                .catch(failureCallback);
            },

            eventClick: function (info) {
              const m = info.event.extendedProps;
              alert(`[${m.mealType}] 메뉴\n\n${m.menu}\n\n칼로리: ${m.calories || "정보 없음"} kcal`);
            },
          });

          calendar.render();

          mealTypeFilter.addEventListener("change", () => {
            calendar.refetchEvents();
          });
        });
      </script>
    </th:block>
  </body>
</html>
