<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>학부모 공지 - 상세</title>
  </head>
  <body>
    <div layout:fragment="content">
      <!-- Breadcrumb -->
      <div class="breadcrumb d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <div>
          <h6 class="fw-semibold mb-0">게시판</h6>
          <p class="text-neutral-600 mt-4 mb-0">학부모 공지</p>
        </div>
        <ul class="d-flex align-items-center gap-2">
          <li class="fw-medium">
            <a th:href="@{/dashboard}" class="d-flex align-items-center gap-1 hover-text-primary">
              <iconify-icon icon="solar:home-smile-angle-outline" class="icon text-lg"></iconify-icon>
              홈
            </a>
          </li>
          <li>-</li>
          <li class="fw-medium">게시판</li>
          <li>-</li>
          <li class="fw-medium">
            <a th:href="@{/board/parent-notice}" class="hover-text-primary">학부모 공지</a>
          </li>
          <li>-</li>
          <li class="fw-medium">상세보기</li>
        </ul>
      </div>

      <!-- 게시물 상세 -->
      <div class="card radius-12">
        <div class="card-header py-16 px-24 border-bottom">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="d-flex gap-8 mb-8">
                <span th:if="${board.pinned}" class="badge bg-danger-100 text-danger-600">공지</span>
                <span th:if="${board.targetClassroomName != null}" th:text="${board.targetClassroomName}" class="badge bg-info-100 text-info-600"></span>
                <span th:elseif="${board.targetGrade != null}" th:text="${board.targetGrade} + '학년'" class="badge bg-success-100 text-success-600"></span>
                <span th:else class="badge bg-primary-100 text-primary-600">전체</span>
              </div>
              <h5 class="mb-8" th:text="${board.title}">제목</h5>
              <div class="d-flex gap-16 text-secondary-light">
                <span>
                  <iconify-icon icon="mdi:account" class="me-4"></iconify-icon>
                  <span th:text="${board.writerName}">작성자</span>
                </span>
                <span>
                  <iconify-icon icon="mdi:calendar" class="me-4"></iconify-icon>
                  <span th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
                </span>
                <span>
                  <iconify-icon icon="mdi:eye" class="me-4"></iconify-icon>
                  <span th:text="${board.viewCount}">조회수</span>
                </span>
              </div>
            </div>
            <!-- 수정/삭제 버튼 (교사/ADMIN) -->
            <div class="d-flex gap-8" sec:authorize="hasAnyRole('TEACHER', 'ADMIN')">
              <button type="button" class="btn btn-outline-primary-600 radius-8" onclick="editBoard()">
                <iconify-icon icon="mdi:pencil" class="me-4"></iconify-icon>
                수정
              </button>
              <button type="button" class="btn btn-outline-danger-600 radius-8" onclick="deleteBoard()">
                <iconify-icon icon="mdi:delete" class="me-4"></iconify-icon>
                삭제
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-24">
          <div class="content" style="min-height: 300px; white-space: pre-wrap;" th:text="${board.content}">
            내용
          </div>
        </div>
        <div class="card-footer py-16 px-24 border-top">
          <a th:href="@{/board/parent-notice}" class="btn btn-secondary-600 radius-8">
            <iconify-icon icon="mdi:arrow-left" class="me-4"></iconify-icon>
            목록으로
          </a>
        </div>
      </div>

      <!-- [woo] 수정 모달 -->
      <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">게시물 수정</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-16">
                <label class="form-label fw-semibold">제목</label>
                <input type="text" id="editTitle" class="form-control" th:value="${board.title}">
              </div>
              <div class="mb-16">
                <label class="form-label fw-semibold">내용</label>
                <textarea id="editContent" class="form-control" rows="12" th:text="${board.content}"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary-600" onclick="submitEdit()">저장</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="css">
    </th:block>

    <th:block layout:fragment="script">
      <script th:inline="javascript">
        const boardId = [[${board.id}]];

        // [woo] 수정 모달 열기
        function editBoard() {
          new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // [woo] 수정 내용 PUT /api/board/{id} 로 전송
        function submitEdit() {
          const title = document.getElementById('editTitle').value.trim();
          const content = document.getElementById('editContent').value.trim();
          if (!title) { alert('제목을 입력해주세요.'); return; }
          if (!content) { alert('내용을 입력해주세요.'); return; }

          fetch('/api/board/' + boardId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
          })
          .then(response => {
            if (response.ok) { location.reload(); }
            else { return response.text().then(text => { throw new Error(text); }); }
          })
          .catch(error => { alert('수정 실패: ' + error.message); });
        }

        function deleteBoard() {
          if (!confirm('정말 삭제하시겠습니까?')) return;

          fetch('/api/board/' + boardId, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (response.ok) {
              alert('삭제되었습니다.');
              location.href = '/board/parent-notice';
            } else {
              return response.text().then(text => { throw new Error(text); });
            }
          })
          .catch(error => {
            alert('삭제 실패: ' + error.message);
          });
        }
      </script>
    </th:block>
  </body>
</html>
