<!doctype html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>학생 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
      /* 이벤트 타입별 색상 */
      .event-EVENT { background-color: #0d6efd !important; color: #fff !important; }
      .event-EXAM { background-color: #dc3545 !important; color: #fff !important; }
      .event-HOLIDAY { background-color: #ffc107 !important; color: #000 !important; }
      .event-VACATION { background-color: #198754 !important; color: #fff !important; }
      .event-FIELD_TRIP { background-color: #0dcaf0 !important; color: #000 !important; }
      .event-MEETING { background-color: #6610f2 !important; color: #fff !important; }
      .event-BRIEFING { background-color: #d63384 !important; color: #fff !important; }
      .event-OTHER { background-color: #6c757d !important; color: #fff !important; }

      /* 미니 캘린더 스타일 */
      #miniCalendar {
        font-size: 11px;
      }
      #miniCalendar .fc-toolbar-title {
        font-size: 14px !important;
      }
      #miniCalendar .fc-button {
        padding: 2px 6px !important;
        font-size: 11px !important;
      }
      #miniCalendar .fc-daygrid-day {
        min-height: 28px !important;
      }
      #miniCalendar .fc-daygrid-day-number {
        font-size: 11px;
        padding: 2px 4px !important;
      }
      #miniCalendar .fc-event {
        font-size: 9px !important;
        padding: 1px 2px !important;
      }
      #miniCalendar .fc-col-header-cell-cushion {
        font-size: 10px;
        padding: 4px 0 !important;
      }
    </style>
  </head>

  <div layout:fragment="content">
    <div th:if="${student == null}" class="card border-0 shadow-sm p-80 text-center">
      <i class="ri-user-search-line text-5xl text-neutral-300 mb-16"></i>
      <h5 class="text-secondary-light">학생 정보를 불러올 수 없습니다.</h5>
    </div>

    <div th:if="${student != null}">
      <!-- 상단 3개 카드 -->
      <div class="row gy-4 mb-24">
        <!-- 학생 프로필 카드 -->
        <div class="col-xl-4 col-md-5">
          <div class="card border-0 shadow-sm p-24 h-100 text-center" style="border-radius: 16px">
            <div
              class="w-120-px h-120-px rounded-circle mx-auto mb-16 overflow-hidden border border-width-4-px border-white"
            >
              <img
                th:src="${profileImageUrl != null ? profileImageUrl : '/images/default-profile.png'}"
                alt="Student Image"
                class="w-100 h-100 object-fit-cover"
              />
            </div>
            <h4 class="fw-bold mb-4" th:text="${student.userName}">학생 이름</h4>
            <p class="text-secondary-light text-sm mb-12">
              <span th:text="${student.year}">1</span>학년 <span th:text="${student.classNum}">2</span>반
              <span th:text="${student.studentNumber}">3</span>번
            </p>
            <span
              id="studentStatusBadge"
              class="badge bg-success-600 px-16 py-6 rounded-pill fs-13 mx-auto mb-24"
              th:text="${student.status?.description} ?: '재학'"
            >
              재학
            </span>

            <div class="border-top pt-20">
              <h6 class="fw-bold mb-20 text-sm text-start">
                <i class="ri-checkbox-circle-line text-success-600 me-2"></i>출결 현황
              </h6>
              <div class="d-flex justify-content-around text-center">
                <div>
                  <div
                    class="w-56-px h-56-px rounded-circle bg-success-600 d-flex align-items-center justify-content-center mx-auto mb-8"
                  >
                    <span class="text-white fw-bold fs-18">20</span>
                  </div>
                  <span class="text-xs text-secondary-light">출석</span>
                </div>
                <div>
                  <div
                    class="w-56-px h-56-px rounded-circle bg-warning-main d-flex align-items-center justify-content-center mx-auto mb-8"
                  >
                    <span class="text-white fw-bold fs-18">1</span>
                  </div>
                  <span class="text-xs text-secondary-light">지각</span>
                </div>
                <div>
                  <div
                    class="w-56-px h-56-px rounded-circle bg-danger-main d-flex align-items-center justify-content-center mx-auto mb-8"
                  >
                    <span class="text-white fw-bold fs-18">0</span>
                  </div>
                  <span class="text-xs text-secondary-light">결석</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 오늘의 시간표 -->
        <div class="col-xl-4 col-md-7">
          <div class="card border-0 shadow-sm h-100 overflow-hidden" style="border-radius: 16px">
            <div class="p-16 border-bottom">
              <h6 class="fw-bold mb-0 text-sm">
                <i class="ri-time-line text-primary-600 me-2"></i>오늘의 시간표 (7교시)
              </h6>
            </div>
            <div class="p-16">
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">1교시</span>
                  <span class="text-secondary-light ms-8">09:00-09:45</span>
                </span>
                <span class="fw-medium text-dark text-sm">국어</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">2교시</span>
                  <span class="text-secondary-light ms-8">09:55-10:40</span>
                </span>
                <span class="fw-medium text-dark text-sm">수학</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">3교시</span>
                  <span class="text-secondary-light ms-8">10:50-11:35</span>
                </span>
                <span class="fw-medium text-dark text-sm">영어</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">4교시</span>
                  <span class="text-secondary-light ms-8">11:45-12:30</span>
                </span>
                <span class="fw-medium text-dark text-sm">과학</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">5교시</span>
                  <span class="text-secondary-light ms-8">13:30-14:15</span>
                </span>
                <span class="fw-medium text-dark text-sm">사회</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center mb-8">
                <span class="text-sm">
                  <span class="fw-bold">6교시</span>
                  <span class="text-secondary-light ms-8">14:25-15:10</span>
                </span>
                <span class="fw-medium text-dark text-sm">체육</span>
              </div>
              <div class="p-10 bg-neutral-50 rounded-8 d-flex justify-content-between align-items-center">
                <span class="text-sm">
                  <span class="fw-bold">7교시</span>
                  <span class="text-secondary-light ms-8">15:20-16:05</span>
                </span>
                <span class="fw-medium text-dark text-sm">자습</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 학교 일정 -->
        <div class="col-xl-4 col-md-12">
          <div class="card border-0 shadow-sm h-100 p-20" style="border-radius: 16px">
            <!-- 헤더 + 토글 버튼 -->
            <div class="d-flex justify-content-between align-items-center mb-20">
              <h6 class="fw-bold mb-0 text-sm">
                <i class="ri-calendar-event-line text-primary-600 me-2"></i>학교 일정
              </h6>
              <button id="toggleCalendarBtn" class="btn btn-sm btn-outline-primary rounded-pill px-12 py-4">
                <i class="ri-calendar-2-line"></i> 캘린더
              </button>
            </div>

            <!-- 목록 뷰 (기본) -->
            <div id="eventListView">
              <th:block th:if="${upcomingEvents != null and !upcomingEvents.empty}">
                <div
                  th:each="event, stat : ${upcomingEvents}"
                  class="d-flex align-items-center justify-content-between"
                  th:classappend="${!stat.last} ? 'mb-16' : ''"
                >
                  <div class="d-flex align-items-center gap-12">
                    <i class="ri-calendar-line text-secondary-light"></i>
                    <span class="text-sm" th:text="${event.dateRangeText + ' ' + event.title}">일정</span>
                  </div>
                  <span
                    class="badge text-white px-12 py-4 rounded-pill"
                    th:classappend="${event.dDay <= 3} ? 'bg-danger-main' : 'bg-primary-600'"
                    th:text="${event.dDay == 0} ? 'D-DAY' : 'D-' + ${event.dDay}"
                    >D-0</span
                  >
                </div>
              </th:block>
              <div
                th:if="${upcomingEvents == null or upcomingEvents.empty}"
                class="text-center text-secondary-light text-sm py-20"
              >
                예정된 일정이 없습니다.
              </div>
            </div>

            <!-- 캘린더 뷰 (숨김) -->
            <div id="eventCalendarView" style="display: none">
              <div id="miniCalendar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 중단: 공지사항 + 오늘의 급식 -->
      <div class="row gy-4 mb-24">
        <!-- 공지사항 -->
        <div class="col-xl-8">
          <div class="card border-0 shadow-sm p-20" style="border-radius: 16px">
            <div class="d-flex justify-content-between align-items-center mb-20">
              <h6 class="fw-bold mb-0 text-sm"><i class="ri-notification-badge-line text-primary-600 me-2"></i>공지사항</h6>
              <a href="/student/notice/list" class="text-primary-600 hover-text-primary-700 text-sm">더보기</a>
            </div>
            <th:block th:if="${notices != null and !notices.empty}">
              <div
                th:each="notice, stat : ${notices}"
                class="d-flex align-items-center justify-content-between py-12"
                th:classappend="${!stat.last} ? 'border-bottom' : ''"
              >
                <div class="d-flex align-items-center gap-12">
                  <i class="ri-file-text-line text-secondary-light"></i>
                  <a
                    th:href="@{/student/notice/read(nno=${notice.nno})}"
                    class="text-sm text-primary-light hover-text-primary-600"
                    th:text="${notice.title}"
                  >[공지] 제목</a>
                </div>
                <span class="text-xs text-secondary-light" th:text="${#temporals.format(notice.createDate, 'yyyy-MM-dd')}">2026-01-20</span>
              </div>
            </th:block>
            <div th:if="${notices == null or notices.empty}" class="text-center text-secondary-light text-sm py-20">
              등록된 공지사항이 없습니다.
            </div>
          </div>
        </div>

        <!-- 오늘의 급식 -->
        <div class="col-xl-4">
          <div class="card border-0 shadow-sm p-20 h-100" style="border-radius: 16px">
            <h6 class="fw-bold mb-20 text-sm"><i class="ri-restaurant-2-line text-primary-600 me-2"></i>오늘의 급식</h6>
            <p class="text-sm mb-12">잡곡밥, 미역국, 제육볶음, 배추김치, 과일</p>
            <span class="badge bg-primary-100 text-primary-600 px-8 py-4 rounded-pill text-xs">칼로리: 645kcal</span>
          </div>
        </div>
      </div>

      <!-- 하단: 학급 알림장 -->
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow-sm p-20" style="border-radius: 16px">
            <h6 class="fw-bold mb-20 text-sm">
              <i class="ri-notification-3-line text-warning-main me-2"></i>학급 알림장
            </h6>
            <div class="d-flex align-items-center justify-content-between py-12 border-bottom">
              <div class="d-flex align-items-center gap-12">
                <i class="ri-notification-line text-secondary-light"></i>
                <span class="text-sm">내일 수학 퀴즈 있습니다</span>
              </div>
              <span class="text-xs text-secondary-light">2026-01-26</span>
            </div>
            <div class="d-flex align-items-center justify-content-between py-12 border-bottom">
              <div class="d-flex align-items-center gap-12">
                <i class="ri-notification-line text-secondary-light"></i>
                <span class="text-sm">체육복 준비해오세요</span>
              </div>
              <span class="text-xs text-secondary-light">2026-01-25</span>
            </div>
            <div class="d-flex align-items-center justify-content-between py-12">
              <div class="d-flex align-items-center gap-12">
                <i class="ri-notification-line text-secondary-light"></i>
                <span class="text-sm">과학 실험 준비물 확인</span>
              </div>
              <span class="text-xs text-secondary-light">2026-01-24</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <th:block layout:fragment="script">
    <script th:inline="javascript">
      // 토글 버튼 클릭 이벤트
      document.getElementById("toggleCalendarBtn")?.addEventListener("click", function () {
        const listView = document.getElementById("eventListView");
        const calendarView = document.getElementById("eventCalendarView");
        const btn = this;

        if (listView.style.display !== "none") {
          listView.style.display = "none";
          calendarView.style.display = "block";
          btn.innerHTML = '<i class="ri-list-check"></i> 목록';

          // 캘린더 초기화 (최초 1회)
          if (!window.miniCalendarInitialized) {
            initMiniCalendar();
            window.miniCalendarInitialized = true;
          }
        } else {
          listView.style.display = "block";
          calendarView.style.display = "none";
          btn.innerHTML = '<i class="ri-calendar-2-line"></i> 캘린더';
        }
      });

      // 미니 캘린더 초기화
      function initMiniCalendar() {
        new FullCalendar.Calendar(document.getElementById("miniCalendar"), {
          initialView: "dayGridMonth",
          locale: "ko",
          height: "auto",
          contentHeight: "auto",
          aspectRatio: 1.2,
          headerToolbar: { left: "prev", center: "title", right: "next" },
          dayMaxEvents: 1,
          fixedWeekCount: false,
          events: function (info, success, failure) {
            const date = new Date((info.start.getTime() + info.end.getTime()) / 2);
            fetch("/soojin/api/events?year=" + date.getFullYear() + "&month=" + (date.getMonth() + 1))
              .then((res) => res.json())
              .then((data) =>
                success(
                  data.map((e) => ({
                    title: e.title,
                    start: e.startDate,
                    end: e.endDate,
                    className: "event-" + e.eventType,
                  })),
                ),
              )
              .catch((err) => failure(err));
          },
        }).render();
      }
    </script>
  </th:block>
</html>
